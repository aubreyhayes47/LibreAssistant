<!-- Plugin Catalogue UI for LibreAssistant -->
<div id="plugin-catalogue" class="catalogue-view">
  <header class="catalogue-header">
    <h1>Plugin Catalogue</h1>
    <p>Manage, enable, and configure LibreAssistant plugins</p>
  </header>
  <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
    <input id="plugin-search" type="text" placeholder="Search plugins..." style="flex:1; padding:0.5em; font-size:1rem; border-radius:4px; border:1px solid #ccc;">
    <select id="plugin-filter" style="padding:0.5em; font-size:1rem; border-radius:4px; border:1px solid #ccc;">
      <option value="all">All</option>
      <option value="enabled">Enabled</option>
      <option value="disabled">Disabled</option>
    </select>
  </div>
  <div class="catalogue-list" id="catalogue-list">
    <!-- Plugin items will be rendered here by JS -->
  </div>
</div>

<!-- Plugin Details Modal -->
<div id="plugin-details-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" id="close-plugin-details">&times;</span>
  <div id="plugin-details-content"></div>
  </div>
</div>

<!-- Plugin Config Modal -->
<div id="plugin-config-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" id="close-plugin-config">&times;</span>
    <div id="plugin-config-content"></div>
  </div>
</div>

<style>
.catalogue-view { padding: 2rem; }
.catalogue-header { margin-bottom: 1.5rem; }
.catalogue-list { display: flex; flex-wrap: wrap; gap: 1.5rem; }
.plugin-card {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  padding: 1.25rem;
  width: 320px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  position: relative;
}
.plugin-card .plugin-title { font-size: 1.2rem; font-weight: 600; }
.plugin-card .plugin-desc { color: #555; font-size: 0.98rem; }
.plugin-card .plugin-status {
  position: absolute; top: 1rem; right: 1rem;
  font-size: 0.9rem; font-weight: 500;
  padding: 0.2em 0.7em; border-radius: 1em;
}
.plugin-card .status-running { background: #d1fae5; color: #065f46; }
.plugin-card .status-stopped { background: #fee2e2; color: #991b1b; }
.plugin-card .status-error { background: #fef3c7; color: #92400e; }
.plugin-card .plugin-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
.plugin-card button { font-size: 0.98rem; padding: 0.3em 1em; border-radius: 4px; border: none; cursor: pointer; }
.plugin-card .btn-enable { background: #10b981; color: #fff; }
.plugin-card .btn-disable { background: #f87171; color: #fff; }
.plugin-card .btn-config { background: #2563eb; color: #fff; }
.plugin-card .btn-details { background: #6b7280; color: #fff; }
</style>

<script>

// Example: This would be replaced by backend data fetch
const plugins = [
  {
    id: "brave-search",
    name: "Brave Search",
    description: "Provides web search results using the Brave Search API.",
    status: "running",
    enabled: true,
    hasConfig: true,
    permissions: ["network"],
    config: { api_key: { type: "string", description: "Brave API Key", required: true } },
    homepage: "https://github.com/libreassistant/plugins/brave-search",
    version: "1.0.0",
    author: "LibreAssistant Team"
  },
  {
    id: "courtlistener",
    name: "CourtListener",
    description: "Legal research plugin for US court opinions.",
    status: "stopped",
    enabled: false,
    hasConfig: false,
    permissions: ["network"],
    config: {},
    homepage: "https://courtlistener.com/",
    version: "0.9.2",
    author: "Free Law Project"
  }
];

let searchQuery = '';
let filterValue = 'all';

let pluginStatuses = {};

async function fetchPluginStatuses() {
  const resp = await fetch('/api/plugin/status');
  const data = await resp.json();
  if (data && data.statuses) {
    pluginStatuses = data.statuses;
  }
}

function getStatusIndicator(status, running) {
  if (status === 'error') return '<span style="color:#dc2626;font-size:1.2em;vertical-align:middle;">●</span>';
  if (running) return '<span style="color:#22c55e;font-size:1.2em;vertical-align:middle;">●</span>';
  if (status === 'stopped') return '<span style="color:#a1a1aa;font-size:1.2em;vertical-align:middle;">●</span>';
  return '';
}

function renderCatalogue() {
  const list = document.getElementById('catalogue-list');
  list.innerHTML = '';
  let filtered = plugins.filter(plugin => {
    const matchesSearch =
      plugin.name.toLowerCase().includes(searchQuery) ||
      plugin.description.toLowerCase().includes(searchQuery) ||
      (plugin.id && plugin.id.toLowerCase().includes(searchQuery));
    let matchesFilter = true;
    if (filterValue === 'enabled') matchesFilter = plugin.enabled;
    if (filterValue === 'disabled') matchesFilter = !plugin.enabled;
    return matchesSearch && matchesFilter;
  });
  filtered.forEach(plugin => {
    const card = document.createElement('div');
    card.className = 'plugin-card';
    card.innerHTML = `
      <div class="plugin-title">${plugin.name}</div>
      <div class="plugin-desc">${plugin.description}</div>
      <div class="plugin-status status-${plugin.status}">${plugin.status.charAt(0).toUpperCase() + plugin.status.slice(1)}</div>
      <div class="plugin-actions">
        <button class="${plugin.enabled ? 'btn-disable' : 'btn-enable'}" onclick="togglePlugin('${plugin.id}')">${plugin.enabled ? 'Disable' : 'Enable'}</button>
        ${plugin.hasConfig ? `<button class="btn-config" onclick="openConfig('${plugin.id}')">Configure</button>` : ''}
        <button class="btn-details" onclick="openDetails('${plugin.id}')">Details</button>
      </div>
    `;
    list.appendChild(card);
  });
}

async function renderCatalogue() {
  await fetchPluginStatuses();
  const list = document.getElementById('catalogue-list');
  list.innerHTML = '';
  let filtered = plugins.filter(plugin => {
    const matchesSearch =
      plugin.name.toLowerCase().includes(searchQuery) ||
      plugin.description.toLowerCase().includes(searchQuery) ||
      (plugin.id && plugin.id.toLowerCase().includes(searchQuery));
    let matchesFilter = true;
    if (filterValue === 'enabled') matchesFilter = plugin.enabled;
    if (filterValue === 'disabled') matchesFilter = !plugin.enabled;
    return matchesSearch && matchesFilter;
  });
  filtered.forEach(plugin => {
    const statusObj = pluginStatuses[plugin.id] || { status: plugin.status, running: plugin.enabled };
    const card = document.createElement('div');
    card.className = 'plugin-card';
    card.innerHTML = `
      <div class="plugin-title">${plugin.name} ${getStatusIndicator(statusObj.status, statusObj.running)}</div>
      <div class="plugin-desc">${plugin.description}</div>
      <div class="plugin-status status-${statusObj.status}">${statusObj.status.charAt(0).toUpperCase() + statusObj.status.slice(1)}</div>
      <div class="plugin-actions">
        <button class="${plugin.enabled ? 'btn-disable' : 'btn-enable'}" onclick="togglePlugin('${plugin.id}')">${plugin.enabled ? 'Disable' : 'Enable'}</button>
        ${plugin.hasConfig ? `<button class="btn-config" onclick="openConfig('${plugin.id}')">Configure</button>` : ''}
        <button class="btn-details" onclick="openDetails('${plugin.id}')">Details</button>
      </div>
    `;
    list.appendChild(card);
  });
}

document.getElementById('plugin-search').addEventListener('input', function(e) {
  searchQuery = e.target.value.toLowerCase();
  renderCatalogue();
});

document.getElementById('plugin-filter').addEventListener('change', function(e) {
  filterValue = e.target.value;
  renderCatalogue();
});

// Poll for status updates every 3 seconds
setInterval(renderCatalogue, 3000);

async function togglePlugin(id) {
  const plugin = plugins.find(p => p.id === id);
  if (!plugin) return;
  // If enabling and permissions required, prompt first
  if (!plugin.enabled && plugin.permissions && plugin.permissions.length) {
    // Call backend to check if permissions are granted
    const resp = await fetch(`/api/plugin/permissions/${id}`);
    const data = await resp.json();
    if (data && data.missing && data.missing.length > 0) {
      if (!confirm(`This plugin requires permissions: ${data.missing.join(", ")}.
Grant these permissions?`)) {
        return;
      }
      // Grant permissions via backend
      await fetch(`/api/plugin/permissions/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ grant: data.missing })
      });
    }
  }
  // For local-fileio, ensure base_directory is set before enabling
  if (!plugin.enabled && plugin.id === 'local-fileio') {
    const resp = await fetch(`/api/plugin/config/${id}`);
    const data = await resp.json();
    if (!data || !data.config || !data.config.base_directory) {
      alert('Please configure the base directory before enabling Local File I/O.');
      openConfig(id);
      return;
    }
  }
  // Call backend to enable/disable
  const url = plugin.enabled ? '/api/plugin/disable' : '/api/plugin/enable';
  const resp2 = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ plugin_id: id })
  });
  const result = await resp2.json();
  if (result.success) {
    plugin.enabled = !plugin.enabled;
    plugin.status = plugin.enabled ? 'running' : 'stopped';
    renderCatalogue();
  } else {
    alert('Failed to ' + (plugin.enabled ? 'disable' : 'enable') + ' plugin: ' + (result.error || 'Unknown error'));
  }
}

async function openConfig(id) {
  // Fetch config schema and current config from backend
  const plugin = plugins.find(p => p.id === id);
  if (!plugin) return;
  const resp = await fetch(`/api/plugin/config/${id}`);
  const data = await resp.json();
  let current = data && data.config ? data.config : {};
  let fields = plugin.config || {};
  let html = `<h3>Configure ${plugin.name}</h3><form id="plugin-config-form">`;
  // Special UI for CourtListener API key
  if (id === 'courtlistener' && fields.api_key) {
    html += `<label><strong>${fields.api_key.description}</strong><br>
      <input type="text" name="api_key" id="courtlistener-api-key" value="${current.api_key || ''}" style="width:100%;margin-bottom:0.5em;">
      <br><input type="checkbox" id="use-default-api-key"> Use LibreAssistant CourtListener Key (default)
      <br><a href="https://www.courtlistener.com/profile/api/" target="_blank">Get your own API key</a>
      <div id="api-key-status" style="margin-top:0.5em;font-size:0.98em;"></div>
    </label><br>`;
  } else if (id === 'brave_search' && fields.api_key) {
    html += `<label><strong>${fields.api_key.description}</strong><br>
      <input type="text" name="api_key" id="brave-search-api-key" value="${current.api_key || ''}" style="width:100%;margin-bottom:0.5em;">
      <br><a href="https://search.brave.com/help/api" target="_blank">Get your Brave Search API key</a>
      <div id="brave-api-key-status" style="margin-top:0.5em;font-size:0.98em;"></div>
      <br><button type="button" id="remove-brave-api-key" style="margin-top:0.5em;">Remove API Key</button>
    </label><br>`;
  } else {
    for (const [key, meta] of Object.entries(fields)) {
      html += `<label><strong>${meta.description || key}</strong><br>`;
      html += `<input type="${meta.type === 'string' ? 'text' : meta.type}" name="${key}" value="${current[key] || ''}" ${meta.required ? 'required' : ''} style="width:100%;margin-bottom:1em;"></label><br>`;
    }
  }
  html += `<button type="submit" style="margin-top:1em;">Save</button></form>`;
  document.getElementById('plugin-config-content').innerHTML = html;
  document.getElementById('plugin-config-modal').style.display = 'block';

  // Default API key value (should match what the plugin/server uses)
  const LIBREASSISTANT_DEFAULT_KEY = 'libreassistant-demo-key';

  if (id === 'courtlistener' && fields.api_key) {
    const apiKeyInput = document.getElementById('courtlistener-api-key');
    const useDefault = document.getElementById('use-default-api-key');
    // If no user key, default to checked
    useDefault.checked = !apiKeyInput.value;
    if (useDefault.checked) apiKeyInput.value = LIBREASSISTANT_DEFAULT_KEY;
    useDefault.onchange = () => {
      if (useDefault.checked) {
        apiKeyInput.value = LIBREASSISTANT_DEFAULT_KEY;
      } else {
        apiKeyInput.value = '';
      }
    };
  }

  if (id === 'brave_search' && fields.api_key) {
    const apiKeyInput = document.getElementById('brave-search-api-key');
    const removeBtn = document.getElementById('remove-brave-api-key');
    removeBtn.onclick = async () => {
      apiKeyInput.value = '';
      // Save empty key to remove
      const resp2 = await fetch(`/api/plugin/config/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ config: { api_key: '' } })
      });
      const result = await resp2.json();
      if (result.success) {
        document.getElementById('brave-api-key-status').innerHTML = '<span style="color:#16a34a;">API key removed.</span>';
      } else {
        document.getElementById('brave-api-key-status').innerHTML = '<span style="color:#dc2626;">Failed to remove API key.</span>';
      }
    };
  }

  document.getElementById('plugin-config-form').onsubmit = async function(e) {
    e.preventDefault();
    const form = e.target;
    const config = {};
    for (const [key, meta] of Object.entries(fields)) {
      config[key] = form.elements[key].value;
    }
    // For CourtListener, handle default key
    if (id === 'courtlistener' && fields.api_key) {
      const useDefault = document.getElementById('use-default-api-key').checked;
      config.api_key = useDefault ? LIBREASSISTANT_DEFAULT_KEY : form.elements['api_key'].value;
    }
    const resp2 = await fetch(`/api/plugin/config/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ config })
    });
    const result = await resp2.json();
    if (result.success) {
      // Validate API key (simulate: always valid for default, else check with backend if implemented)
      let valid = false;
      if (id === 'courtlistener') {
        valid = config.api_key === LIBREASSISTANT_DEFAULT_KEY || config.api_key.length > 10;
        document.getElementById('api-key-status').innerHTML = valid ? '<span style="color:#16a34a;">API key valid.</span>' : '<span style="color:#dc2626;">API key may be invalid.</span>';
      }
      if (id === 'brave_search') {
        valid = config.api_key && config.api_key.length > 10;
        document.getElementById('brave-api-key-status').innerHTML = valid ? '<span style="color:#16a34a;">API key saved.</span>' : '<span style="color:#dc2626;">API key may be invalid or missing.</span>';
      }
      alert('Configuration saved!');
      document.getElementById('plugin-config-modal').style.display = 'none';
    } else {
      alert('Failed to save config: ' + (result.error || 'Unknown error'));
    }
  };
}

document.getElementById('close-plugin-config').onclick = function() {
  document.getElementById('plugin-config-modal').style.display = 'none';
};


function openDetails(id) {
  const plugin = plugins.find(p => p.id === id);
  document.getElementById('plugin-details-modal').style.display = 'block';
  let perms = plugin.permissions && plugin.permissions.length ? plugin.permissions.map(p => `<code>${p}</code>`).join(', ') : 'None';
  let configFields = plugin.config && Object.keys(plugin.config).length
    ? `<ul>` + Object.entries(plugin.config).map(([k, v]) => `<li><strong>${k}</strong>: ${v.description || ''} <em>(${v.type}${v.required ? ', required' : ''})</em></li>`).join('') + `</ul>`
    : 'None';
  let html = `
    <h2>${plugin.name}</h2>
    <p>${plugin.description}</p>
    <p><strong>Status:</strong> ${plugin.status}</p>
    <p><strong>Enabled:</strong> ${plugin.enabled ? 'Yes' : 'No'}</p>
    <p><strong>Plugin ID:</strong> <code>${plugin.id}</code></p>
    <p><strong>Version:</strong> ${plugin.version || ''}</p>
    <p><strong>Author:</strong> ${plugin.author || ''}</p>
    <p><strong>Homepage:</strong> ${plugin.homepage ? `<a href="${plugin.homepage}" target="_blank">${plugin.homepage}</a>` : 'N/A'}</p>
    <p><strong>Permissions:</strong> ${perms}</p>
    <p><strong>Config Fields:</strong> ${configFields}</p>
  `;
  // If local-fileio and enabled, show file browser UI
  if (plugin.id === 'local-fileio' && plugin.enabled) {
    html += `<hr><div id="fileio-ui"><h3>File Browser</h3>
      <div style="margin-bottom:0.5em;">
        <input id="fileio-path" type="text" value="" placeholder="(relative to base directory)" style="width:60%;">
        <button onclick="fileioList()">List</button>
        <button onclick="fileioUp()">Up</button>
      </div>
      <div id="fileio-list"></div>
      <div id="fileio-file-actions" style="margin-top:1em;"></div>
    </div>`;
    setTimeout(() => fileioList(), 100); // Initial list
  }
  document.getElementById('plugin-details-content').innerHTML = html;
}

// File I/O UI logic (scoped globally for modal)
async function fileioList() {
  const path = document.getElementById('fileio-path').value || '';
  const res = await fetch('http://localhost:5101/list', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path })
  });
  const data = await res.json();
  const listDiv = document.getElementById('fileio-list');
  if (!data.success) {
    listDiv.innerHTML = `<span style='color:#dc2626;'>${data.error}</span>`;
    return;
  }
  let html = '<ul style="list-style:none;padding-left:0;">';
  for (const f of data.files) {
    html += `<li>
      <span style="cursor:pointer;color:${f.is_dir ? '#2563eb' : '#222'};" onclick="fileioSelect('${f.name}', ${f.is_dir})">${f.is_dir ? '📁' : '📄'} ${f.name}</span>
      ${!f.is_dir ? `<button style='margin-left:1em;' onclick='fileioRead("${f.name}")'>Read</button>
      <button onclick='fileioDelete("${f.name}")'>Delete</button>` : ''}
      ${f.is_dir ? `<button style='margin-left:1em;' onclick='fileioEnterDir("${f.name}")'>Open</button>` : ''}
    </li>`;
  }
  html += '</ul>';
  listDiv.innerHTML = html;
  document.getElementById('fileio-file-actions').innerHTML = `<button onclick='fileioShowWrite()'>New File</button>`;
}
function fileioSelect(name, isDir) {
  // No-op for now
}
function fileioEnterDir(name) {
  const pathInput = document.getElementById('fileio-path');
  pathInput.value = (pathInput.value ? pathInput.value + '/' : '') + name;
  fileioList();
}
function fileioUp() {
  const pathInput = document.getElementById('fileio-path');
  let parts = pathInput.value.split('/').filter(Boolean);
  parts.pop();
  pathInput.value = parts.join('/');
  fileioList();
}
async function fileioRead(name) {
  const path = (document.getElementById('fileio-path').value ? document.getElementById('fileio-path').value + '/' : '') + name;
  const res = await fetch('http://localhost:5101/read', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path })
  });
  const data = await res.json();
  if (data.success) {
    document.getElementById('fileio-file-actions').innerHTML = `<h4>Viewing: ${name}</h4><textarea id='fileio-edit' style='width:100%;height:120px;'>${data.content.replace(/</g,'&lt;')}</textarea><br><button onclick='fileioWrite("${name}")'>Save</button>`;
  } else {
    document.getElementById('fileio-file-actions').innerHTML = `<span style='color:#dc2626;'>${data.error}</span>`;
  }
}
function fileioShowWrite() {
  document.getElementById('fileio-file-actions').innerHTML = `<h4>New File</h4><input id='fileio-newname' type='text' placeholder='filename.txt'><br><textarea id='fileio-edit' style='width:100%;height:120px;'></textarea><br><button onclick='fileioWriteNew()'>Create</button>`;
}
async function fileioWrite(name) {
  const path = (document.getElementById('fileio-path').value ? document.getElementById('fileio-path').value + '/' : '') + name;
  const content = document.getElementById('fileio-edit').value;
  const res = await fetch('http://localhost:5101/write', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path, content })
  });
  const data = await res.json();
  if (data.success) {
    alert('File saved!');
    fileioList();
  } else {
    alert('Error: ' + data.error);
  }
}
async function fileioWriteNew() {
  const name = document.getElementById('fileio-newname').value;
  if (!name) return alert('Enter a filename');
  await fileioWrite(name);
}
async function fileioDelete(name) {
  if (!confirm('Delete ' + name + '?')) return;
  const path = (document.getElementById('fileio-path').value ? document.getElementById('fileio-path').value + '/' : '') + name;
  const res = await fetch('http://localhost:5101/delete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path })
  });
  const data = await res.json();
  if (data.success) {
    alert('Deleted!');
    fileioList();
  } else {
    alert('Error: ' + data.error);
  }
}
document.getElementById('close-plugin-details').onclick = function() {
  document.getElementById('plugin-details-modal').style.display = 'none';
};

// Initial render
// Initial render
renderCatalogue();
</script>
