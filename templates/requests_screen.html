<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreAssistant - Requests</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Requests Screen UI for LibreAssistant -->
    <div class="app-container">
        <!-- Navigation -->
        <nav class="top-nav">
            <div class="nav-brand">
                <h2><i class="fas fa-brain"></i> LibreAssistant</h2>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="/requests_screen" class="nav-link active"><i class="fas fa-paper-plane"></i> Requests</a>
                <a href="/plugin_catalogue" class="nav-link"><i class="fas fa-puzzle-piece"></i> Plugins</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div id="requests-screen" class="requests-view">
                <header class="view-header">
                    <h1>Make Requests</h1>
                    <p>Send discrete requests to LibreAssistant with plugin support</p>
                </header>
                
                <div class="requests-bar">
                    <div class="controls-row">
                        <div class="model-selection">
                            <label for="model-select">Model:</label>
                            <select id="model-select" class="form-select">
                                <option value="">Loading models...</option>
                            </select>
                            <button id="refresh-models" class="btn btn-link" title="Refresh models">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="schema-controls">
                            <label class="checkbox-label">
                                <input type="checkbox" id="use-schema" checked>
                                <span>Use JSON Schema</span>
                            </label>
                            <button id="view-schema" class="btn btn-link" title="View JSON schema">
                                <i class="fas fa-code"></i>
                            </button>
                        </div>
                    </div>
                    <div class="input-group">
                        <input id="request-input" type="text" placeholder="Ask LibreAssistant..." autocomplete="off" />
                        <button id="request-submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    <ul id="autocomplete-list" class="autocomplete-list" style="display:none;"></ul>
                </div>
                
                <div id="response-box" class="response-box">
                    <div class="placeholder-message">
                        <i class="fas fa-comment-dots"></i>
                        <span>Responses will appear here. Try asking a question or request!</span>
                    </div>
                </div>
                
                <div id="active-plugins-bar" class="active-plugins-bar">
                    <div class="plugins-header">
                        <h4><i class="fas fa-plug"></i> Active Plugins</h4>
                        <div class="plugin-actions">
                            <button id="refresh-plugins" class="btn btn-link" title="Refresh plugins">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="view-system-instructions" class="btn btn-link" title="View system instructions">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                    <div id="plugin-pills"></div>
                    <div id="plugin-status" class="plugin-status"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Plugin Modals -->
    <div id="schema-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('schema-modal').style.display='none'">&times;</span>
            <div>
                <h3><i class="fas fa-code"></i> JSON Schema</h3>
                <div class="form-row">
                    <button id="validate-response" class="btn btn-secondary">Test Validation</button>
                    <button id="download-schema" class="btn btn-link">Download Schema</button>
                </div>
                <pre id="schema-content" class="schema-display"></pre>
            </div>
        </div>
    </div>

    <div id="instructions-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('instructions-modal').style.display='none'">&times;</span>
            <div>
                <h3><i class="fas fa-info-circle"></i> System Instructions</h3>
                <div class="form-row">
                    <button id="refresh-instructions" class="btn btn-secondary">Refresh</button>
                    <span id="plugin-count" class="status-message"></span>
                </div>
                <pre id="instructions-content" class="instructions-display"></pre>
            </div>
        </div>
    </div>
    <div id="brave-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('brave-modal').style.display='none'">&times;</span>
            <div id="brave-ui">
                <h3><i class="fab fa-brave"></i> Brave Search</h3>
                <div class="form-row">
                    <input id="brave-search-query" type="text" placeholder="Search the web..." class="form-input">
                    <button onclick="braveSearch()" class="btn btn-primary">Search</button>
                    <a href="https://search.brave.com/help/api" target="_blank" class="btn btn-link">API Docs</a>
                </div>
                <div id="brave-status" class="status-message"></div>
            </div>
        </div>
    </div>

    <div id="courtlistener-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('courtlistener-modal').style.display='none'">&times;</span>
            <div id="courtlistener-ui">
                <h3><i class="fas fa-gavel"></i> CourtListener Actions</h3>
                <div class="form-row">
                    <input id="cl-search-query" type="text" placeholder="Search cases (query)..." class="form-input">
                    <button onclick="courtlistenerSearch()" class="btn btn-primary">Search</button>
                </div>
                <div class="form-row">
                    <input id="cl-opinion-id" type="text" placeholder="Opinion ID" class="form-input">
                    <button onclick="courtlistenerOpinion()" class="btn btn-secondary">Fetch Opinion</button>
                </div>
                <div class="form-row">
                    <input id="cl-docket-id" type="text" placeholder="Docket ID" class="form-input">
                    <button onclick="courtlistenerDocket()" class="btn btn-secondary">Get Docket</button>
                    <a href="https://www.courtlistener.com/help/api/rest/#overview" target="_blank" class="btn btn-link">API Docs</a>
                </div>
                <div id="cl-status" class="status-message"></div>
            </div>
        </div>
    </div>

    <style>
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-nav {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-brand h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .requests-view {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .view-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .view-header h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .view-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .requests-bar {
            position: relative;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .model-selection {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .schema-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-select {
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
            min-width: 150px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        #request-input {
            flex: 1;
            font-size: 1.1rem;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            outline: none;
            transition: border-color 0.3s;
        }

        #request-input:focus {
            border-color: #3498db;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-link {
            background: transparent;
            color: #3498db;
            text-decoration: underline;
        }

        .response-box {
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
        }

        .placeholder-message {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-top: 2rem;
        }

        .placeholder-message i {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }

        .active-plugins-bar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
        }

        .active-plugins-bar h4 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
        }

        .plugins-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .plugin-actions {
            display: flex;
            gap: 0.5rem;
        }

        .plugin-status {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        #plugin-pills {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .plugin-pill {
            background: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .plugin-pill:hover {
            background: #2980b9;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 4rem;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .autocomplete-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close:hover {
            color: #2c3e50;
        }

        .form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.5rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .resp-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .resp-table th,
        .resp-table td {
            border: 1px solid #e0e0e0;
            padding: 0.5rem;
            text-align: left;
        }

        .resp-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .schema-display, .instructions-display {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .loading .fa-spinner {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .error-response {
            color: #e74c3c;
            padding: 1rem;
            background: #fdf2f2;
            border-radius: 4px;
            border-left: 4px solid #e74c3c;
        }

        .plugin-indicator {
            background: #e8f5e8;
            border-left: 4px solid #27ae60;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 0 4px 4px 0;
            font-size: 0.9rem;
        }

        .response-text {
            line-height: 1.6;
            margin-top: 1rem;
        }
    </style>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Initialize the requests screen
        document.addEventListener('DOMContentLoaded', function() {
            setupModelSelection();
            setupSchemaControls();
            setupPluginPills();
            setupAutoComplete();
            setupRequestSubmission();
        });

        // Setup model selection functionality
        function setupModelSelection() {
            const modelSelect = document.getElementById('model-select');
            const refreshButton = document.getElementById('refresh-models');
            
            function loadModels() {
                modelSelect.innerHTML = '<option value="">Loading models...</option>';
                
                fetch('/api/models')
                    .then(res => res.json())
                    .then(data => {
                        modelSelect.innerHTML = '';
                        if (data.success && data.models && data.models.length > 0) {
                            data.models.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.name;
                                option.textContent = model.name;
                                modelSelect.appendChild(option);
                            });
                            // Select first model by default
                            modelSelect.value = data.models[0].name;
                        } else {
                            // Fallback for when no Ollama server is available - add a test model
                            const option = document.createElement('option');
                            option.value = 'test-model';
                            option.textContent = 'Test Model (No Ollama)';
                            modelSelect.appendChild(option);
                            modelSelect.value = 'test-model';
                            console.warn('No models available from Ollama server, using test model');
                        }
                    })
                    .catch(err => {
                        // Fallback for network errors - add a test model  
                        modelSelect.innerHTML = '';
                        const option = document.createElement('option');
                        option.value = 'test-model';
                        option.textContent = 'Test Model (No Ollama)';
                        modelSelect.appendChild(option);
                        modelSelect.value = 'test-model';
                        console.error('Failed to load models:', err);
                    });
            }
            
            refreshButton.addEventListener('click', loadModels);
            loadModels(); // Load initially
        }

        // Setup schema controls functionality
        function setupSchemaControls() {
            const useSchemaCheckbox = document.getElementById('use-schema');
            const viewSchemaButton = document.getElementById('view-schema');
            const schemaModal = document.getElementById('schema-modal');
            const schemaContent = document.getElementById('schema-content');
            const validateButton = document.getElementById('validate-response');
            const downloadButton = document.getElementById('download-schema');
            
            viewSchemaButton.addEventListener('click', function() {
                schemaContent.textContent = 'Loading schema...';
                schemaModal.style.display = 'block';
                
                fetch('/api/llm/schema')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            schemaContent.textContent = JSON.stringify(data.schema, null, 2);
                        } else {
                            schemaContent.textContent = 'Error loading schema: ' + (data.error || 'Unknown error');
                        }
                    })
                    .catch(err => {
                        schemaContent.textContent = 'Network error: ' + err.message;
                    });
            });
            
            validateButton.addEventListener('click', function() {
                // Test validation with a sample response
                const sampleResponse = {
                    "action": "message",
                    "content": {
                        "text": "This is a test message",
                        "markdown": false
                    }
                };
                
                fetch('/api/llm/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ response: sampleResponse })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.success && data.valid ? 'Sample validation passed!' : 'Validation failed: ' + (data.error || 'Unknown error'));
                })
                .catch(err => {
                    alert('Validation test failed: ' + err.message);
                });
            });
            
            downloadButton.addEventListener('click', function() {
                fetch('/api/llm/schema')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const blob = new Blob([JSON.stringify(data.schema, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'llm-response-schema.json';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                    })
                    .catch(err => {
                        alert('Failed to download schema: ' + err.message);
                    });
            });
        }
        // Setup plugin pills functionality
        function setupPluginPills() {
            const refreshButton = document.getElementById('refresh-plugins');
            const viewInstructionsButton = document.getElementById('view-system-instructions');
            const instructionsModal = document.getElementById('instructions-modal');
            const instructionsContent = document.getElementById('instructions-content');
            const refreshInstructionsButton = document.getElementById('refresh-instructions');
            const pluginCountSpan = document.getElementById('plugin-count');
            const pluginStatus = document.getElementById('plugin-status');
            
            function loadPlugins() {
                // Load active plugins
                fetch('/api/plugins/list')
                    .then(res => res.json())
                    .then(data => {
                        const pillsContainer = document.getElementById('plugin-pills');
                        if (data.success && data.plugins && data.plugins.length > 0) {
                            pillsContainer.innerHTML = '';
                            const runningPlugins = data.plugins.filter(p => p.running);
                            
                            runningPlugins.forEach(plugin => {
                                const pill = document.createElement('span');
                                pill.className = 'plugin-pill';
                                pill.innerHTML = `<i class="fas fa-plug"></i> ${plugin.name}`;
                                pill.title = plugin.description;
                                pill.onclick = function() {
                                    showPluginInfo(plugin);
                                };
                                pillsContainer.appendChild(pill);
                            });
                            
                            pluginStatus.textContent = `${runningPlugins.length} active plugin(s)`;
                        } else {
                            pillsContainer.innerHTML = '<span style="color: #7f8c8d;">No active plugins</span>';
                            pluginStatus.textContent = 'No plugins running';
                        }
                    })
                    .catch(err => {
                        console.error('Could not load plugin pills:', err);
                        document.getElementById('plugin-pills').innerHTML = '<span style="color: #e74c3c;">Error loading plugins</span>';
                        pluginStatus.textContent = 'Error loading plugins';
                    });
            }
            
            function loadSystemInstructions() {
                instructionsContent.textContent = 'Loading system instructions...';
                
                fetch('/api/llm/system_instructions')
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            instructionsContent.textContent = data.instructions;
                            pluginCountSpan.textContent = `Available plugins: ${data.plugins ? data.plugins.length : 0}`;
                        } else {
                            instructionsContent.textContent = 'Error loading instructions: ' + (data.error || 'Unknown error');
                        }
                    })
                    .catch(err => {
                        instructionsContent.textContent = 'Network error: ' + err.message;
                    });
            }
            
            function showPluginInfo(plugin) {
                alert(`Plugin: ${plugin.name}\nID: ${plugin.id}\nDescription: ${plugin.description}\nStatus: ${plugin.status}\nVersion: ${plugin.version}`);
            }
            
            refreshButton.addEventListener('click', loadPlugins);
            viewInstructionsButton.addEventListener('click', function() {
                instructionsModal.style.display = 'block';
                loadSystemInstructions();
            });
            refreshInstructionsButton.addEventListener('click', loadSystemInstructions);
            
            loadPlugins(); // Load initially
        }

        // Setup autocomplete functionality
        function setupAutoComplete() {
            const input = document.getElementById('request-input');
            const list = document.getElementById('autocomplete-list');
            
            const suggestions = [
                'Search for recent AI research',
                'Find legal cases about privacy',
                'What are the latest tech trends?',
                'Search for court opinions on data protection',
                'Help me find information about...',
                'What is the current status of...'
            ];

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                list.innerHTML = '';
                
                if (value.length > 0) {
                    const matches = suggestions.filter(s => s.toLowerCase().includes(value));
                    if (matches.length > 0) {
                        matches.forEach(match => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item';
                            item.textContent = match;
                            item.onclick = function() {
                                input.value = match;
                                list.style.display = 'none';
                            };
                            list.appendChild(item);
                        });
                        list.style.display = 'block';
                    } else {
                        list.style.display = 'none';
                    }
                } else {
                    list.style.display = 'none';
                }
            });

            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.style.display = 'none';
                }
            });
        }

        // Setup request submission
        function setupRequestSubmission() {
            const input = document.getElementById('request-input');
            const button = document.getElementById('request-submit');
            const responseBox = document.getElementById('response-box');
            const modelSelect = document.getElementById('model-select');
            const useSchemaCheckbox = document.getElementById('use-schema');

            function sendRequest() {
                const prompt = input.value.trim();
                const selectedModel = modelSelect.value;
                const useSchema = useSchemaCheckbox.checked;
                
                if (!prompt) return;
                
                if (!selectedModel) {
                    showResponse({error: 'Please select a model before sending your request.'});
                    return;
                }

                // Clear placeholder and show loading
                responseBox.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Processing your request...</div>';
                
                // Use the /api/generate endpoint with proper schema support
                const timeout = window.settingsManager ? window.settingsManager.getSetting('apiTimeout') : 180;
                fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: selectedModel,
                        prompt: prompt,
                        use_schema: useSchema,
                        stream: false,
                        timeout: timeout
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showResponse({
                            text: data.response,
                            markdown: data.markdown,
                            plugin_used: data.plugin_used,
                            plugin_reason: data.plugin_reason,
                            schema_used: useSchema,
                            schema_error: data.schema_error
                        });
                        // Refresh plugin pills to show any newly accessed plugins
                        setupPluginPills();
                    } else {
                        // Enhanced error handling with specific messages for different error types
                        let errorMessage = data.error || 'Request failed';
                        let suggestion = data.suggestion || '';
                        let errorClass = 'error-response';
                        
                        // Add specific styling and suggestions for timeout errors
                        if (data.timeout_used !== undefined) {
                            errorClass = 'timeout-error';
                            errorMessage = `⏱️ ${errorMessage}`;
                        } else if (data.connection_error) {
                            errorClass = 'connection-error';
                            errorMessage = `🔌 ${errorMessage}`;
                        }
                        
                        let errorHtml = `<div class="${errorClass}">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Error:</strong> ${errorMessage}`;
                        
                        if (suggestion) {
                            errorHtml += `<br><small><i class="fas fa-lightbulb"></i> <strong>Suggestion:</strong> ${suggestion}</small>`;
                        }
                        
                        errorHtml += '</div>';
                        showResponse({error: errorHtml});
                    }
                })
                .catch(err => {
                    showResponse({error: 'Network error: ' + err.message});
                });

                input.value = '';
            }

            button.addEventListener('click', sendRequest);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendRequest();
                }
            });
        }

        // Show response in the response box
        function showResponse({text, markdown, error, plugin_used, plugin_reason, schema_used, schema_error}) {
            const box = document.getElementById('response-box');
            
            if (error) {
                // Check if error already contains HTML formatting
                if (error.includes('<div')) {
                    box.innerHTML = error;
                } else {
                    box.innerHTML = `<div class="error-response"><i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${error}</div>`;
                }
                return;
            }
            
            let content = '';
            
            // Schema status indicator
            if (schema_used) {
                if (schema_error) {
                    content += `<div class="schema-warning" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 0.8rem; margin-bottom: 1rem; border-radius: 0 4px 4px 0; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Schema Warning:</strong> ${schema_error}
                    </div>`;
                } else {
                    content += `<div class="schema-success" style="background: #d4edda; border-left: 4px solid #28a745; padding: 0.8rem; margin-bottom: 1rem; border-radius: 0 4px 4px 0; font-size: 0.9rem;">
                        <i class="fas fa-check-circle"></i> <strong>Schema Validation:</strong> Response validated successfully
                    </div>`;
                }
            }
            
            // Plugin usage indicator
            if (plugin_used) {
                content += `<div class="plugin-indicator"><i class="fas fa-plug"></i> <strong>Plugin Used:</strong> ${plugin_used}`;
                if (plugin_reason) content += ` - ${plugin_reason}`;
                content += '</div>';
            }
            
            // Response content
            if (markdown) {
                // Simple markdown rendering (you might want to use a proper markdown library)
                content += `<div class="response-text">${text}</div>`;
            } else {
                content += `<div class="response-text">${text}</div>`;
            }
            
            box.innerHTML = content;
        }

        // Plugin-specific functions
        async function braveSearch() {
            const query = document.getElementById('brave-search-query').value.trim();
            if (!query) return;

            document.getElementById('brave-status').textContent = 'Searching...';
            
            try {
                // Call Brave Search endpoint directly
                const res = await fetch('http://localhost:5103/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: JSON.stringify(data, null, 2), markdown: false});
                    document.getElementById('brave-modal').style.display = 'none';
                } else {
                    document.getElementById('brave-status').textContent = 'Error: ' + (data.error || 'Search failed');
                }
            } catch (e) {
                document.getElementById('brave-status').textContent = 'Error: ' + e.message;
            }
        }

        async function courtlistenerSearch() {
            const query = document.getElementById('cl-search-query').value.trim();
            if (!query) return;

            document.getElementById('cl-status').textContent = 'Searching...';
            
            try {
                // Call CourtListener search endpoint directly
                const res = await fetch('http://localhost:5102/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: JSON.stringify(data, null, 2), markdown: false});
                    document.getElementById('courtlistener-modal').style.display = 'none';
                } else {
                    document.getElementById('cl-status').textContent = 'Error: ' + (data.error || 'Search failed');
                }
            } catch (e) {
                document.getElementById('cl-status').textContent = 'Error: ' + e.message;
            }
        }

        async function courtlistenerOpinion() {
            const id = document.getElementById('cl-opinion-id').value.trim();
            if (!id) return;

            document.getElementById('cl-status').textContent = 'Fetching opinion...';
            
            try {
                // Call CourtListener opinion endpoint directly
                const res = await fetch('http://localhost:5102/opinion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ opinion_id: id })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: JSON.stringify(data, null, 2), markdown: false});
                    document.getElementById('courtlistener-modal').style.display = 'none';
                } else {
                    document.getElementById('cl-status').textContent = 'Error: ' + (data.error || 'Fetch failed');
                }
            } catch (e) {
                document.getElementById('cl-status').textContent = 'Error: ' + e.message;
            }
        }

        async function courtlistenerDocket() {
            const id = document.getElementById('cl-docket-id').value.trim();
            if (!id) return;

            document.getElementById('cl-status').textContent = 'Fetching docket...';
            
            try {
                // Call CourtListener docket endpoint directly
                const res = await fetch('http://localhost:5102/docket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ docket_id: id })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: JSON.stringify(data, null, 2), markdown: false});
                    document.getElementById('courtlistener-modal').style.display = 'none';
                } else {
                    document.getElementById('cl-status').textContent = 'Error: ' + (data.error || 'Fetch failed');
                }
            } catch (e) {
                document.getElementById('cl-status').textContent = 'Error: ' + e.message;
            }
        }
    </script>
</body>
</html>