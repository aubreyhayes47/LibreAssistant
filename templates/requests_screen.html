<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreAssistant - Requests</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Requests Screen UI for LibreAssistant -->
    <div class="app-container">
        <!-- Navigation -->
        <nav class="top-nav">
            <div class="nav-brand">
                <h2><i class="fas fa-brain"></i> LibreAssistant</h2>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="/requests_screen" class="nav-link active"><i class="fas fa-paper-plane"></i> Requests</a>
                <a href="/plugin_catalogue" class="nav-link"><i class="fas fa-puzzle-piece"></i> Plugins</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div id="requests-screen" class="requests-view">
                <header class="view-header">
                    <h1>Make Requests</h1>
                    <p>Send discrete requests to LibreAssistant with plugin support</p>
                </header>
                
                <div class="requests-bar">
                    <div class="input-group">
                        <input id="request-input" type="text" placeholder="Ask LibreAssistant..." autocomplete="off" />
                        <button id="request-submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    <ul id="autocomplete-list" class="autocomplete-list" style="display:none;"></ul>
                </div>
                
                <div id="response-box" class="response-box">
                    <div class="placeholder-message">
                        <i class="fas fa-comment-dots"></i>
                        <span>Responses will appear here. Try asking a question or request!</span>
                    </div>
                </div>
                
                <div id="active-plugins-bar" class="active-plugins-bar">
                    <h4><i class="fas fa-plug"></i> Active Plugins</h4>
                    <div id="plugin-pills"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Plugin Modals -->
    <div id="brave-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('brave-modal').style.display='none'">&times;</span>
            <div id="brave-ui">
                <h3><i class="fab fa-brave"></i> Brave Search</h3>
                <div class="form-row">
                    <input id="brave-search-query" type="text" placeholder="Search the web..." class="form-input">
                    <button onclick="braveSearch()" class="btn btn-primary">Search</button>
                    <a href="https://search.brave.com/help/api" target="_blank" class="btn btn-link">API Docs</a>
                </div>
                <div id="brave-status" class="status-message"></div>
            </div>
        </div>
    </div>

    <div id="courtlistener-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('courtlistener-modal').style.display='none'">&times;</span>
            <div id="courtlistener-ui">
                <h3><i class="fas fa-gavel"></i> CourtListener Actions</h3>
                <div class="form-row">
                    <input id="cl-search-query" type="text" placeholder="Search cases (query)..." class="form-input">
                    <button onclick="courtlistenerSearch()" class="btn btn-primary">Search</button>
                </div>
                <div class="form-row">
                    <input id="cl-opinion-id" type="text" placeholder="Opinion ID" class="form-input">
                    <button onclick="courtlistenerOpinion()" class="btn btn-secondary">Fetch Opinion</button>
                </div>
                <div class="form-row">
                    <input id="cl-docket-id" type="text" placeholder="Docket ID" class="form-input">
                    <button onclick="courtlistenerDocket()" class="btn btn-secondary">Get Docket</button>
                    <a href="https://www.courtlistener.com/help/api/rest/#overview" target="_blank" class="btn btn-link">API Docs</a>
                </div>
                <div id="cl-status" class="status-message"></div>
            </div>
        </div>
    </div>

    <style>
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-nav {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-brand h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .requests-view {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .view-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .view-header h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .view-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .requests-bar {
            position: relative;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        #request-input {
            flex: 1;
            font-size: 1.1rem;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            outline: none;
            transition: border-color 0.3s;
        }

        #request-input:focus {
            border-color: #3498db;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-link {
            background: transparent;
            color: #3498db;
            text-decoration: underline;
        }

        .response-box {
            min-height: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
        }

        .placeholder-message {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1rem;
            margin-top: 2rem;
        }

        .placeholder-message i {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }

        .active-plugins-bar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e0e0e0;
        }

        .active-plugins-bar h4 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
        }

        #plugin-pills {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .plugin-pill {
            background: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .plugin-pill:hover {
            background: #2980b9;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 4rem;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .autocomplete-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close:hover {
            color: #2c3e50;
        }

        .form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .form-input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.5rem;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .resp-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .resp-table th,
        .resp-table td {
            border: 1px solid #e0e0e0;
            padding: 0.5rem;
            text-align: left;
        }

        .resp-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
    </style>

    <script>
        // Initialize the requests screen
        document.addEventListener('DOMContentLoaded', function() {
            setupPluginPills();
            setupAutoComplete();
            setupRequestSubmission();
        });

        // Setup plugin pills functionality
        function setupPluginPills() {
            // Load active plugins
            fetch('/api/plugins/accessed')
                .then(res => res.json())
                .then(data => {
                    const pillsContainer = document.getElementById('plugin-pills');
                    if (data.plugins && data.plugins.length > 0) {
                        data.plugins.forEach(plugin => {
                            const pill = document.createElement('span');
                            pill.className = 'plugin-pill';
                            pill.textContent = plugin;
                            pill.onclick = function() {
                                if (plugin.includes('courtlistener') || plugin.includes('CourtListener')) {
                                    document.getElementById('courtlistener-modal').style.display = 'block';
                                } else if (plugin.includes('brave') || plugin.includes('Brave')) {
                                    document.getElementById('brave-modal').style.display = 'block';
                                }
                            };
                            pillsContainer.appendChild(pill);
                        });
                    } else {
                        pillsContainer.innerHTML = '<span style="color: #7f8c8d;">No plugins accessed yet</span>';
                    }
                })
                .catch(err => {
                    console.log('Could not load plugin pills:', err);
                });
        }

        // Setup autocomplete functionality
        function setupAutoComplete() {
            const input = document.getElementById('request-input');
            const list = document.getElementById('autocomplete-list');
            
            const suggestions = [
                'Search for recent AI research',
                'Find legal cases about privacy',
                'What are the latest tech trends?',
                'Search for court opinions on data protection',
                'Help me find information about...',
                'What is the current status of...'
            ];

            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                list.innerHTML = '';
                
                if (value.length > 0) {
                    const matches = suggestions.filter(s => s.toLowerCase().includes(value));
                    if (matches.length > 0) {
                        matches.forEach(match => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item';
                            item.textContent = match;
                            item.onclick = function() {
                                input.value = match;
                                list.style.display = 'none';
                            };
                            list.appendChild(item);
                        });
                        list.style.display = 'block';
                    } else {
                        list.style.display = 'none';
                    }
                } else {
                    list.style.display = 'none';
                }
            });

            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.style.display = 'none';
                }
            });
        }

        // Setup request submission
        function setupRequestSubmission() {
            const input = document.getElementById('request-input');
            const button = document.getElementById('request-submit');
            const responseBox = document.getElementById('response-box');

            function sendRequest() {
                const prompt = input.value.trim();
                if (!prompt) return;

                // Clear placeholder and show loading
                responseBox.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Processing your request...</div>';
                
                // For now, this is a placeholder - in a real implementation, this would call the LibreAssistant API
                fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'default', // This would be selected from available models
                        prompt: prompt,
                        use_schema: true
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showResponse({
                            text: data.response,
                            markdown: data.markdown,
                            plugin_used: data.plugin_used,
                            plugin_reason: data.plugin_reason
                        });
                        // Update plugin pills
                        setupPluginPills();
                    } else {
                        showResponse({error: data.error || 'Request failed'});
                    }
                })
                .catch(err => {
                    showResponse({error: 'Network error: ' + err.message});
                });

                input.value = '';
            }

            button.addEventListener('click', sendRequest);
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendRequest();
                }
            });
        }

        // Show response in the response box
        function showResponse({text, markdown, error, plugin_used, plugin_reason}) {
            const box = document.getElementById('response-box');
            
            if (error) {
                box.innerHTML = `<div class="error-response"><i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> ${error}</div>`;
                return;
            }
            
            let content = '';
            if (plugin_used) {
                content += `<div class="plugin-indicator"><i class="fas fa-plug"></i> Used plugin: <strong>${plugin_used}</strong>`;
                if (plugin_reason) content += ` - ${plugin_reason}`;
                content += '</div>';
            }
            
            if (markdown) {
                // Simple markdown rendering (you might want to use a proper markdown library)
                content += `<div class="response-text">${text}</div>`;
            } else {
                content += `<div class="response-text">${text}</div>`;
            }
            
            box.innerHTML = content;
        }

        // Plugin-specific functions
        async function braveSearch() {
            const query = document.getElementById('brave-search-query').value.trim();
            if (!query) return;

            document.getElementById('brave-status').textContent = 'Searching...';
            
            try {
                const res = await fetch('/api/plugin/invoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plugin: 'brave_search',
                        input: { query: query }
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: data.response, markdown: true});
                    document.getElementById('brave-modal').style.display = 'none';
                } else {
                    document.getElementById('brave-status').textContent = 'Error: ' + (data.error || 'Search failed');
                }
            } catch (e) {
                document.getElementById('brave-status').textContent = 'Error: ' + e.message;
            }
        }

        async function courtlistenerSearch() {
            const query = document.getElementById('cl-search-query').value.trim();
            if (!query) return;

            document.getElementById('cl-status').textContent = 'Searching...';
            
            try {
                const res = await fetch('/api/plugin/invoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plugin: 'courtlistener',
                        input: { action: 'search', query: query }
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: data.response, markdown: true});
                    document.getElementById('courtlistener-modal').style.display = 'none';
                } else {
                    document.getElementById('cl-status').textContent = 'Error: ' + (data.error || 'Search failed');
                }
            } catch (e) {
                document.getElementById('cl-status').textContent = 'Error: ' + e.message;
            }
        }

        async function courtlistenerOpinion() {
            const id = document.getElementById('cl-opinion-id').value.trim();
            if (!id) return;

            document.getElementById('cl-status').textContent = 'Fetching opinion...';
            
            try {
                const res = await fetch('/api/plugin/invoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plugin: 'courtlistener',
                        input: { action: 'opinion', opinion_id: id }
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: data.response, markdown: true});
                    document.getElementById('courtlistener-modal').style.display = 'none';
                } else {
                    document.getElementById('cl-status').textContent = 'Error: ' + (data.error || 'Fetch failed');
                }
            } catch (e) {
                document.getElementById('cl-status').textContent = 'Error: ' + e.message;
            }
        }

        async function courtlistenerDocket() {
            const id = document.getElementById('cl-docket-id').value.trim();
            if (!id) return;

            document.getElementById('cl-status').textContent = 'Fetching docket...';
            
            try {
                const res = await fetch('/api/plugin/invoke', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plugin: 'courtlistener',
                        input: { action: 'docket', docket_id: id }
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showResponse({text: data.response, markdown: true});
                    document.getElementById('courtlistener-modal').style.display = 'none';
                } else {
                    document.getElementById('cl-status').textContent = 'Error: ' + (data.error || 'Fetch failed');
                }
            } catch (e) {
                document.getElementById('cl-status').textContent = 'Error: ' + e.message;
            }
        }
    </script>
</body>
</html>